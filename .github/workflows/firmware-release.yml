name: Firmware Release

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0, 0.1.0b2)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build-firmware:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Extract version from tag (v0.1.0 -> 0.1.0, 0.1.0b2 -> 0.1.0b2)
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Convert to short format for filename (0.1.0-beta.2 -> 0.1.0b2)
          SHORT_VERSION=$(echo "$VERSION" | sed -E 's/-alpha\./a/' | sed -E 's/-beta\./b/' | sed -E 's/-rc\./rc/')
          echo "short_version=$SHORT_VERSION" >> $GITHUB_OUTPUT

          echo "Building firmware version: $VERSION (short: $SHORT_VERSION)"

      - name: Install Rust toolchain for ESP32
        uses: esp-rs/xtensa-toolchain@v1.5
        with:
          default: true
          buildtargets: esp32s3
          ldproxy: true

      - name: Install espflash
        run: cargo install espflash

      - name: Update firmware version in Cargo.toml
        working-directory: firmware
        run: |
          # Convert shorthand to Cargo semver (0.1.0b2 -> 0.1.0-beta.2)
          CARGO_VERSION=$(echo "${{ steps.version.outputs.version }}" | \
            sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+)a([0-9]+)$/\1-alpha.\2/' | \
            sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+)b([0-9]+)$/\1-beta.\2/' | \
            sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+)rc([0-9]+)$/\1-rc.\2/')

          sed -i "s/^version = \".*\"/version = \"$CARGO_VERSION\"/" Cargo.toml
          echo "Set Cargo.toml version to: $CARGO_VERSION"
          grep "^version" Cargo.toml

      - name: Build firmware
        working-directory: firmware
        run: cargo build --release

      - name: Create firmware binary
        working-directory: firmware
        run: |
          mkdir -p releases
          espflash save-image --chip esp32s3 \
            target/xtensa-esp32s3-espidf/release/spoolbuddy-firmware \
            releases/spoolbuddy-${{ steps.version.outputs.short_version }}.bin

      - name: Verify firmware binary
        working-directory: firmware
        run: |
          BINARY="releases/spoolbuddy-${{ steps.version.outputs.short_version }}.bin"

          # Check file exists and has content
          if [ ! -s "$BINARY" ]; then
            echo "ERROR: Binary file is empty or missing"
            exit 1
          fi

          # Verify ESP32 magic byte (0xE9)
          MAGIC=$(head -c 1 "$BINARY" | od -An -tx1 | tr -d ' ')
          if [ "$MAGIC" != "e9" ]; then
            echo "ERROR: Invalid ESP32 binary (magic: 0x$MAGIC, expected 0xe9)"
            exit 1
          fi

          SIZE=$(du -h "$BINARY" | cut -f1)
          echo "Firmware binary verified: $SIZE"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ steps.version.outputs.short_version }}
          path: firmware/releases/spoolbuddy-${{ steps.version.outputs.short_version }}.bin

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: "SpoolBuddy v${{ steps.version.outputs.short_version }}"
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          generate_release_notes: true
          files: |
            firmware/releases/spoolbuddy-${{ steps.version.outputs.short_version }}.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
